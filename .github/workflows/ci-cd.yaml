name: CI-CD

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    name: Build & Test (CI)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Restore
        run: dotnet restore

      - name: Build
        run: dotnet build -c Release --no-restore

      - name: Test
        run: dotnet test DemoAppCICD.Tests/DemoAppCICD.Tests.csproj -c Release --no-build

      - name: Publish
        run: dotnet publish DemoAppCICD/DemoAppCICD.csproj -c Release -o publish --no-build

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: demoapi
          path: publish/

  deploy:
    name: Deploy to IIS (on-prem)
    needs: build
    runs-on: [ self-hosted, windows ]

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: demoapi
          path: webapp

      - name: Take app offline
        shell: powershell
        run: |
          $dest = "D:\Sites\DemoApi\current"
          New-Item -ItemType Directory -Force -Path $dest | Out-Null
          "App offline" | Out-File -Encoding utf8 "$dest\app_offline.htm"

      - name: Copy files
        shell: powershell
        run: |
          $src  = "$env:GITHUB_WORKSPACE\webapp"
          $dest = "D:\Sites\DemoApi\current"
          robocopy $src $dest /MIR /R:2 /W:2
          $code = $LASTEXITCODE
          if ($code -ge 8) { exit $code } else { exit 0 }

      - name: Bring app online + recycle app pool
        shell: powershell
        run: |
          Remove-Item "D:\Sites\DemoApi\current\app_offline.htm" -ErrorAction SilentlyContinue
          Import-Module WebAdministration
          Restart-WebAppPool -Name "DemoApiPool"
